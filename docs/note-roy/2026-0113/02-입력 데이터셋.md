# AutoRAG 입력 데이터셋 가이드

AutoRAG 평가를 실행하려면 두 가지 데이터셋이 필요합니다.

---

## 필수 데이터셋

| 파일 | 설명 |
|------|------|
| `qa.parquet` | 평가용 질문-답변 쌍 |
| `corpus.parquet` | 검색 대상 문서 모음 |

---

## 데이터 구조

### QA 데이터 (qa.parquet)

평가에 사용되는 질문-답변 쌍입니다.

| 컬럼 | 타입 | 필수 | 설명 |
|------|------|:----:|------|
| `qid` | string | O | 질문 고유 ID (UUID 형식) |
| `query` | string | O | 질문 텍스트 |
| `retrieval_gt` | list[list[string]] | O | 정답 문서 ID 리스트 |
| `retrieval_gt_contents` | list[list[string]] | - | 정답 문서 내용 |
| `generation_gt` | list[string] | O | 정답 답변 (여러 개 가능) |

**예시:**

```python
{
    "qid": "edbe6036-eac3-4a1b-9c2d-...",
    "query": "신청자가 사업계획서를 작성할 때 어떤 사항을 반드시 기재해야 합니까?",
    "retrieval_gt": [["33ba42be-...", "a1b2c3d4-..."]],
    "retrieval_gt_contents": [["문서 내용...", "다른 문서 내용..."]],
    "generation_gt": ["공동대표 또는 각자대표의 경력, 이력 등입니다."]
}
```

### Corpus 데이터 (corpus.parquet)

검색 대상이 되는 문서 모음입니다.

| 컬럼 | 타입 | 필수 | 설명 |
|------|------|:----:|------|
| `doc_id` | string | O | 문서 고유 ID (UUID 형식) |
| `contents` | string | O | 문서 내용 (청킹된 텍스트) |
| `path` | string | - | 원본 파일 경로 |
| `start_end_idx` | tuple | - | 원본에서의 시작/끝 인덱스 |
| `metadata` | dict | - | 메타데이터 (날짜, 페이지 등) |

**예시:**

```python
{
    "doc_id": "33ba42be-1234-5678-...",
    "contents": "2024년 글로벌 팁스 사업계획서 작성 시...",
    "path": "data/tips_guide.pdf",
    "start_end_idx": (0, 1024),
    "metadata": {"page": 1, "source": "tips_guide.pdf"}
}
```

---

## 샘플 데이터

AutoRAG에는 테스트용 샘플 데이터가 포함되어 있습니다.

```text
tests/resources/dataset_sample_gen_by_autorag/
├── qa.parquet      # 20개 질문-답변 쌍
└── corpus.parquet  # 55개 문서
```

**데이터 출처**: 2024년 글로벌 팁스(Global TIPS) 창업기업 모집 공고문

---

## 사용 방법

### 1. 샘플 데이터로 빠른 테스트

```bash
make quick-test          # OpenAI API 사용
make quick-test-custom   # 커스텀 LLM 서버 사용
```

### 2. 커스텀 데이터로 평가

프로젝트 루트에 `qa.parquet`과 `corpus.parquet` 파일을 두고:

```bash
make evaluate
```

### 3. 직접 경로 지정

```bash
autorag evaluate \
  --config sample_config/rag/korean/non_gpu/simple_korean.yaml \
  --qa_data_path /path/to/your/qa.parquet \
  --corpus_data_path /path/to/your/corpus.parquet \
  --project_dir logs
```

---

## 데이터 생성 방법

### 전체 흐름

```text
원시 문서 (PDF 등) → 파싱 → 청킹 → QA 생성
                      ↓        ↓         ↓
              parsed.parquet  corpus.parquet  qa.parquet
```

### 1. 파싱 (문서 → 텍스트)

```python
from autorag.parser import Parser

parser = Parser(data_path_glob="data/*.pdf")
parser.start_parsing("parse_config.yaml")
# 결과: 0/parsed.parquet
```

### 2. 청킹 (텍스트 → 문서 조각)

```python
from autorag.chunker import Chunker

chunker = Chunker.from_parquet(parsed_data_path="0/parsed.parquet")
chunker.start_chunking("chunk_config.yaml")
# 결과: 0/0/corpus.parquet
```

### 3. QA 생성 (문서 → 질문-답변 쌍)

```python
import pandas as pd
from llama_index.llms.openai import OpenAI
from autorag.data.qa.schema import Raw, Corpus
from autorag.data.qa.query.llama_gen_query import factoid_query_gen
from autorag.data.qa.generation_gt.llama_index_gen_gt import make_basic_gen_gt
from autorag.data.qa.sample import random_single_hop

# 데이터 로드
raw_df = pd.read_parquet("0/parsed.parquet")
corpus_df = pd.read_parquet("0/0/corpus.parquet")

raw = Raw(raw_df)
corpus = Corpus(corpus_df, raw)

# QA 생성
llm = OpenAI(model="gpt-4o-mini")

qa = (
    corpus.sample(random_single_hop, n=50)       # 50개 샘플링
    .map(lambda df: df.reset_index(drop=True))
    .make_retrieval_gt_contents()
    .batch_apply(factoid_query_gen, llm=llm)     # 질문 생성
    .batch_apply(make_basic_gen_gt, llm=llm)     # 답변 생성
)

# 저장
qa.to_parquet('./qa.parquet', './corpus.parquet')
```

---

## 데이터 검증

```python
import pandas as pd

# 데이터 로드
qa = pd.read_parquet("qa.parquet")
corpus = pd.read_parquet("corpus.parquet")

# 필수 컬럼 확인
assert all(col in qa.columns for col in ["qid", "query", "retrieval_gt", "generation_gt"])
assert all(col in corpus.columns for col in ["doc_id", "contents"])

# retrieval_gt의 doc_id가 corpus에 존재하는지 확인
corpus_ids = set(corpus["doc_id"])
for gt_list in qa["retrieval_gt"]:
    for gt in gt_list:
        for doc_id in gt:
            assert doc_id in corpus_ids, f"Missing doc_id: {doc_id}"

print("데이터 검증 완료!")
```

---

## 참고 자료

- [청킹(Chunking) 가이드](00-청킹에%20대해.md)
- [빠른 테스트 가이드](빠른테스트.md)
- [샘플 설정 파일](../../sample_config/rag)
