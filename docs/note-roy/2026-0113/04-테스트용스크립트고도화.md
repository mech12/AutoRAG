# 테스트용 스크립트 고도화

## 구현 완료 현황

✅ 테스트 케이스 설정 시스템 구현 완료
✅ 멀티 테스트 케이스 대시보드/웹 인터페이스 구현 완료

## 샘플 데이터 구조

```text
docs/sample-data/
├── 인사규정/
│   └── 인사규정-07-취업규칙.pdf      (507KB)
└── 고압가스/
    └── 기술기준-07-FU212_특수고압가스사용.pdf  (1.4MB)
```

## 설정 파일

**`scripts/test-config.yaml`**

```yaml
# 기본값 (테스트 케이스에서 생략 시 적용)
defaults:
  num_qa: 20
  use_llm: false
  chunk_size: 512
  chunk_overlap: 50
  rag_config: "sample_config/rag/korean/non_gpu/simple_korean_custom.yaml"

# 테스트 케이스 정의
test_cases:
  인사규정:
    description: "취업규칙 PDF 기반 RAG 테스트"
    input_dir: "docs/sample-data/인사규정"
    output_dir: "logs/testCase/인사규정"

  인사규정_llm:
    description: "취업규칙 - LLM 사용 고품질 QA 생성"
    input_dir: "docs/sample-data/인사규정"
    output_dir: "logs/testCase/인사규정_llm"
    num_qa: 50
    use_llm: true

  고압가스:
    description: "특수고압가스 기술기준 PDF 기반 RAG 테스트"
    input_dir: "docs/sample-data/고압가스"
    output_dir: "logs/testCase/고압가스"
    chunk_size: 1024
    chunk_overlap: 100

  고압가스_상세:
    description: "고압가스 - 더 많은 QA 생성"
    input_dir: "docs/sample-data/고압가스"
    output_dir: "logs/testCase/고압가스_상세"
    num_qa: 100
    use_llm: true
    chunk_size: 1024
    chunk_overlap: 100

  전체:
    description: "모든 샘플 PDF 통합 테스트"
    input_dir: "docs/sample-data"
    output_dir: "logs/testCase/전체"
    num_qa: 100
    recursive: true
```

## 출력 폴더 구조

```text
logs/testCase/
├── 인사규정/                      # TESTCASE=인사규정
│   ├── data/                      # prepare-data 결과
│   │   ├── corpus.parquet
│   │   ├── qa.parquet
│   │   ├── parse_config.yaml
│   │   ├── chunk_config.yaml
│   │   ├── parse_project/
│   │   └── chunk_project/
│   └── trial/                     # evaluate-custom 결과
│       ├── 0/
│       │   ├── summary.csv
│       │   ├── config.yaml
│       │   ├── retrieve_node_line/
│       │   └── post_retrieve_node_line/
│       └── trial.json
│
├── 고압가스/                      # TESTCASE=고압가스
│   └── ...
│
└── 전체/                          # TESTCASE=전체
    └── ...
```

## 사용법

### 테스트 케이스 관리

```bash
# 테스트 케이스 목록 확인
make list-testcases

# 출력 예시:
# ============================================================
# 사용 가능한 테스트 케이스
# ============================================================
#
# [인사규정] 취업규칙 PDF 기반 RAG 테스트
#   make run-testcase TESTCASE=인사규정
#   make prepare-data TESTCASE=인사규정
#   make evaluate-custom TESTCASE=인사규정
#
# [고압가스] 특수고압가스 기술기준 PDF 기반 RAG 테스트
#   make run-testcase TESTCASE=고압가스
#   ...

# 특정 테스트 케이스 전체 실행 (prepare-data + evaluate-custom)
make run-testcase TESTCASE=인사규정

# 개별 단계 실행
make prepare-data TESTCASE=인사규정
make evaluate-custom TESTCASE=인사규정

# 결과 비교
make compare-results
```

### 대시보드 및 웹 인터페이스

#### 단일 테스트 케이스 (기본)

```bash
# 대시보드 (Panel 기반) - 단일 trial_dir
make dashboard                    # http://localhost:7690

# 웹 인터페이스 (Streamlit 기반) - 단일 trial_dir
make web                          # http://localhost:8501
```

#### 멀티 테스트 케이스 (신규)

```bash
# 멀티 대시보드 - 테스트 케이스 선택 콤보박스
make multi-dashboard              # http://localhost:7690

# 멀티 웹 인터페이스 - 테스트 케이스 선택 + RAG 질의
make multi-web                    # http://localhost:8501
```

## 구현된 파일

| 파일 | 설명 |
|------|------|
| `scripts/test-config.yaml` | 테스트 케이스 설정 파일 |
| `scripts/testcase_config.py` | 설정 파일 파서 (TestCase 클래스) |
| `scripts/prepare_custom_data.py` | 데이터 준비 (--testcase 지원) |
| `scripts/run_evaluation.py` | 평가 실행 래퍼 |
| `scripts/compare_results.py` | 결과 비교 도구 |
| `scripts/multi_dashboard.py` | 멀티 테스트 케이스 대시보드 |
| `scripts/multi_web.py` | 멀티 테스트 케이스 웹 인터페이스 |

## Vector DB 설정

### 지원하는 Vector DB

관악04 서버(10.10.20.94)에 4가지 Vector DB가 설치되어 있으며, 각각에 대한 설정 파일이 준비되어 있습니다.

| Vector DB | 설정 파일 | 특징 |
|-----------|----------|------|
| **Chroma (로컬)** | `simple_korean_custom.yaml` | 로컬 persistent 모드, 기본값 |
| **Milvus** | `simple_korean_milvus.yaml` | 인증 지원, IVF_FLAT 인덱스 |
| **Weaviate** | `simple_korean_weaviate.yaml` | 하이브리드 검색 (Vector + BM25), gRPC 지원 |
| **Qdrant** | `simple_korean_qdrant.yaml` | 고성능 벡터 검색, 빠른 속도 |
| **Chroma (HTTP)** | `simple_korean_chroma_http.yaml` | 원격 Chroma 서버 연결 |

### 환경변수 설정 (.env)

```bash
# =============================================================================
# Vector Database (Milvus - 관악04)
# =============================================================================
MILVUS_HOST=10.10.20.94
MILVUS_PORT=19530
MILVUS_USER=minioadmin
MILVUS_PASSWORD=minioadmin
MILVUS_COLLECTION_NAME=kb_qna_v1_collection

# Attu (Milvus Web UI)
ATTU_URL=http://10.10.20.94:3001

# =============================================================================
# Alternative Vector Databases (관악04 서버 - 벡터 DB 비교 테스트용)
# =============================================================================
# Weaviate - 하이브리드 검색 (Vector + BM25), GraphQL API
WEAVIATE_HOST=10.10.20.94
WEAVIATE_HTTP_PORT=8088
WEAVIATE_GRPC_PORT=50051
WEAVIATE_URL=http://10.10.20.94:8088

# Qdrant - 고성능 벡터 검색, 빠른 속도
QDRANT_HOST=10.10.20.94
QDRANT_HTTP_PORT=6333
QDRANT_GRPC_PORT=6334
QDRANT_URL=http://10.10.20.94:6333

# Chroma - 초간단 벡터 DB (로컬/POC용)
CHROMA_HOST=10.10.20.94
CHROMA_PORT=8089
CHROMA_URL=http://10.10.20.94:8089
```

### Vector DB별 테스트 케이스 예시

```yaml
# scripts/test-config.yaml

test_cases:
  # Milvus 사용
  인사규정_milvus:
    description: "인사규정 - Milvus Vector DB"
    input_dir: "docs/sample-data/인사규정"
    output_dir: "logs/testCase/인사규정_milvus"
    rag_config: "sample_config/rag/korean/non_gpu/simple_korean_milvus.yaml"

  # Weaviate 사용
  인사규정_weaviate:
    description: "인사규정 - Weaviate Vector DB"
    input_dir: "docs/sample-data/인사규정"
    output_dir: "logs/testCase/인사규정_weaviate"
    rag_config: "sample_config/rag/korean/non_gpu/simple_korean_weaviate.yaml"

  # Qdrant 사용
  인사규정_qdrant:
    description: "인사규정 - Qdrant Vector DB"
    input_dir: "docs/sample-data/인사규정"
    output_dir: "logs/testCase/인사규정_qdrant"
    rag_config: "sample_config/rag/korean/non_gpu/simple_korean_qdrant.yaml"

  # Chroma HTTP 사용
  인사규정_chroma_http:
    description: "인사규정 - Chroma HTTP Vector DB"
    input_dir: "docs/sample-data/인사규정"
    output_dir: "logs/testCase/인사규정_chroma_http"
    rag_config: "sample_config/rag/korean/non_gpu/simple_korean_chroma_http.yaml"
```

### Vector DB 비교 테스트 실행

```bash
# 환경변수 로드
export $(cat .env | xargs)

# 각 Vector DB로 테스트 실행
make run-testcase TESTCASE=인사규정_milvus
make run-testcase TESTCASE=인사규정_weaviate
make run-testcase TESTCASE=인사규정_qdrant
make run-testcase TESTCASE=인사규정_chroma_http

# 결과 비교
make compare-results

# 대시보드에서 비교
make multi-dashboard
```

## 멀티 대시보드 / 웹 인터페이스 설명

### multi_dashboard.py

- Panel 라이브러리 기반 대시보드
- `logs/testCase/*/trial/0/summary.csv`가 있는 테스트 케이스만 표시
- 선택한 테스트 케이스의 평가 결과 조회:
  - 테스트 케이스 정보 (설명, 청크 크기, QA 개수 등)
  - Retrieval 메트릭 (F1, Recall, Precision)
  - Generator 메트릭 (ROUGE, 실행 시간)
  - 전체 Summary 테이블

```bash
make multi-dashboard
# -> http://localhost:7690
```

### multi_web.py

- Streamlit 기반 RAG 질의 인터페이스
- 사이드바에서 테스트 케이스 선택
- 선택한 테스트 케이스의 최적 파이프라인 로드 (`Runner.from_trial_folder`)
- 채팅 형식으로 RAG 질의 수행
- 참조 문서 표시 (retrieved_contents)

```bash
make multi-web
# -> http://localhost:8501
```

## 워크플로우 요약

```text
┌─────────────────────────────────────────────────────────────────────────┐
│                        테스트 케이스 워크플로우                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. 설정 정의          scripts/test-config.yaml                         │
│        │                                                                │
│        ▼                                                                │
│  2. 데이터 준비        make prepare-data TESTCASE=인사규정              │
│        │               → logs/testCase/인사규정/data/                   │
│        ▼                                                                │
│  3. RAG 평가           make evaluate-custom TESTCASE=인사규정           │
│        │               → logs/testCase/인사규정/trial/0/                │
│        ▼                                                                │
│  4. 결과 확인          make multi-dashboard  또는  make compare-results │
│        │                                                                │
│        ▼                                                                │
│  5. RAG 질의           make multi-web                                   │
│                        → 테스트 케이스별 최적 파이프라인으로 질의        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 예시 시나리오

### 시나리오 1: 새 테스트 케이스 추가

```yaml
# scripts/test-config.yaml에 추가
test_cases:
  새규정:
    description: "새로운 규정 문서 테스트"
    input_dir: "docs/sample-data/새규정"
    output_dir: "logs/testCase/새규정"
```

```bash
make run-testcase TESTCASE=새규정
make multi-dashboard   # 결과 확인
make multi-web         # RAG 질의
```

### 시나리오 2: 청크 크기 비교 테스트

```yaml
test_cases:
  인사규정_chunk256:
    input_dir: "docs/sample-data/인사규정"
    output_dir: "logs/testCase/인사규정_chunk256"
    chunk_size: 256

  인사규정_chunk512:
    input_dir: "docs/sample-data/인사규정"
    output_dir: "logs/testCase/인사규정_chunk512"
    chunk_size: 512

  인사규정_chunk1024:
    input_dir: "docs/sample-data/인사규정"
    output_dir: "logs/testCase/인사규정_chunk1024"
    chunk_size: 1024
```

```bash
make run-testcase TESTCASE=인사규정_chunk256
make run-testcase TESTCASE=인사규정_chunk512
make run-testcase TESTCASE=인사규정_chunk1024
make compare-results  # 결과 비교
```

### 시나리오 3: 여러 테스트 케이스 비교

```bash
# 여러 테스트 케이스 실행
make run-testcase TESTCASE=인사규정
make run-testcase TESTCASE=고압가스

# 결과 비교
make compare-results

# 대시보드에서 전환하며 확인
make multi-dashboard

# 각 테스트 케이스별로 RAG 질의
make multi-web
```
